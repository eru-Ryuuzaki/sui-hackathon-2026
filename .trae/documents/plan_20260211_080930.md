# Implementation Plan: Metadata & Contract Refactor

> **For Claude:** REQUIRED SUB-SKILL: Use superpowers:executing-plans to implement this plan task-by-task.

**Goal:** Refactor contract and backend to support media types and clean up unused fields, ensuring a robust hybrid architecture.

**Architecture:** 
1.  **Move Contract**: Remove unused `total_gas_burned` and `is_granted`. Add `media_type` to `MemoryShard` and events.
2.  **Backend**: Sync `media_type` for indexing, remove `energy` field.
3.  **Frontend**: Update transaction building and display logic.

**Tech Stack:** Move (Sui), NestJS (Backend), React (Frontend).

---

### Task 1: Clean up Move Contract

**Files:**
- Modify: `engram/sources/core.move`

**Step 1: Remove Fields**
- Remove `total_gas_burned` and `is_granted` from `Construct` struct.
- Remove initialization of these fields in `jack_in` function.

**Step 2: Add Media Type**
- Ensure `MemoryShard` struct already has `media_type: Option<String>` (it does).
- Update `ShardEngravedEvent` to include `media_type: Option<String>`.
- Update `engrave` function to emit `media_type` in the event.

### Task 2: Update Backend Entities

**Files:**
- Modify: `backend/src/entities/construct.entity.ts`
- Modify: `backend/src/entities/memory-shard.entity.ts`

**Step 1: Clean Construct Entity**
- Remove `energy` column from `Construct` entity.

**Step 2: Update MemoryShard Entity**
- Add `media_type` column (nullable string) to `MemoryShard` entity.

### Task 3: Update Backend Indexer

**Files:**
- Modify: `backend/src/indexer/processors/shard-engraved.processor.ts`

**Step 1: Sync Media Type**
- Update `ShardEngravedProcessor` to extract `media_type` from `event.parsedJson`.
- Save `media_type` to the `MemoryShard` entity.

### Task 4: Frontend Enhancement

**Files:**
- Modify: `frontend/src/utils/sui/transactions.ts`
- Modify: `frontend/src/components/MemoryCard.tsx` (or similar component for list view)

**Step 1: Update Transaction Builder**
- Ensure `buildEngraveTx` correctly passes `media_type` to the Move call.

**Step 2: Update UI**
- In memory list, use `media_type` to render appropriate icons (Image vs Text).

### Task 5: Verification

**Step 1: Build & Deploy Contract**
- Run `sui move build` to ensure contract compiles.
- (Optional) Run `sui move test` if tests exist.

**Step 2: Backend Build**
- Run `npm run build` in backend to ensure type safety.
