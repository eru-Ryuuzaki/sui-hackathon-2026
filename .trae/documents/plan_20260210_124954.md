# Implementation Plan: Pure Indexer Architecture

> **For Claude:** REQUIRED SUB-SKILL: Use superpowers:executing-plans to implement this plan task-by-task.

**Goal:** Refactor the backend to act as a pure indexer and the frontend to handle all transaction building, ensuring a decentralized and robust architecture.

**Architecture:** Frontend-Heavy / Indexer-Light Pattern. The frontend interacts directly with the Sui blockchain for all state changes. The backend passively listens to events for query optimization.

**Tech Stack:** NestJS (Backend), React/Sui SDK (Frontend), Move (Sui Smart Contracts).

---

### Task 1: Backend Indexer Refactoring

**Files:**
- Modify: `backend/src/indexer/processors/shard-engraved.processor.ts`

**Step 1: Update Processor Logic**
- Ensure `ShardEngravedProcessor` extracts `mood` from the event payload.
- Map `mood` to `emotion_val` in the `MemoryShard` entity.
- Remove any default values that ignore the event data.

### Task 2: Backend Cleanup

**Files:**
- Delete: `backend/src/api/transaction.controller.ts`
- Modify: `backend/src/sui/sui.service.ts`

**Step 1: Remove Transaction Controller**
- Delete the controller responsible for building transactions server-side.

**Step 2: Clean Sui Service**
- Remove `buildEngraveTransaction` and related unused methods from `SuiService`.
- Keep only read-only or faucet-related utilities if necessary.

### Task 3: Frontend Transaction Builder Enhancement

**Files:**
- Modify: `frontend/.env`
- Modify: `frontend/src/utils/sui/transactions.ts`

**Step 1: Environment Variables**
- Add `VITE_SUI_PACKAGE_ID`, `VITE_HIVE_STATE_ID`, and `VITE_SUI_MODULE_NAME` to `.env`.

**Step 2: Refactor Transaction Builder**
- Update `transactions.ts` to use `import.meta.env` for contract IDs.
- Ensure `buildEngraveTx` arguments match the Move contract's `engrave` function signature exactly:
    - `construct`, `hive`, `clock`, `content`, `mood`, `category`, `is_encrypted`, `blob_id`, `media_type`.

### Task 4: Verification

**Step 1: Verify Event Definition**
- Check `engram/sources/core.move` to confirm `ShardEngravedEvent` emits `mood`. (Completed during analysis)

**Step 2: End-to-End Test (Manual)**
- Build a transaction on the frontend.
- Execute it on the network (Devnet/Testnet).
- Verify the backend indexer picks up the event and correctly stores the `mood` as `emotion_val`.
